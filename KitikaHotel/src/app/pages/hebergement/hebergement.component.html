<!-- ðŸŽ¨ Vue rÃ©ceptionniste unifiÃ©e -->
<div class="container mx-auto px-4 py-8 font-sans bg-gray-50 min-h-screen">

  <!-- En-tÃªte + filtres -->
  <div class="sticky top-0 z-10 bg-gray-50 py-4 border-b border-gray-200">
    <div class="flex justify-between items-center mb-6 flex-wrap gap-4">
      <h2 class="text-3xl font-extrabold text-blue-900">
        <i class="fas fa-bed mr-2 text-blue-600"></i> Gestion des SÃ©jours
      </h2>
      <button (click)="openReservationForm()"
              class="bg-blue-600 text-white font-bold py-2 px-4 rounded-full shadow hover:bg-blue-700">
        <i class="fas fa-plus mr-2"></i> Nouvelle RÃ©servation
      </button>
    </div>

    <div class="bg-white rounded-xl shadow p-6 mb-6 flex flex-wrap gap-4 items-center">
      <input [(ngModel)]="searchTerm" (input)="filtrerReservations()"
             placeholder="Rechercher un client, une chambre..."
             class="flex-1 min-w-[220px] border rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500">
      <select [(ngModel)]="statutFiltre" (change)="filtrerReservations()"
              class="flex-1 min-w-[160px] border rounded-lg px-4 py-2 bg-white focus:ring-2 focus:ring-blue-500">
        <option value="">Tous les statuts</option>
        <option value="RÃ©servÃ©e">RÃ©servÃ©e</option>
        <option value="Checked-in">Checked-in</option>
        <option value="Check-out">Check-out</option>
      </select>
    </div>
  </div>

  <!-- Tableau des rÃ©servations -->
  <div class="overflow-x-auto bg-white rounded-xl shadow">
    <table class="min-w-full divide-y divide-gray-200">
      <thead class="bg-gray-100">
        <tr>
          <th class="py-3 px-4 text-left text-xs font-semibold text-gray-600 uppercase">Client</th>
          <th class="py-3 px-4 text-left text-xs font-semibold text-gray-600 uppercase">Chambre</th>
          <th class="py-3 px-4 text-left text-xs font-semibold text-gray-600 uppercase">Dates</th>
          <th class="py-3 px-4 text-left text-xs font-semibold text-gray-600 uppercase">Statut</th>
          <th class="py-3 px-4 text-center text-xs font-semibold text-gray-600 uppercase">Actions</th>
        </tr>
      </thead>

      <tbody class="bg-white divide-y divide-gray-200">
        <ng-container *ngFor="let res of reservationsFiltrees">
          <tr class="hover:bg-gray-50">
            <td class="py-3 px-4">
              <div class="font-medium text-gray-900">{{ res.client.nom }} {{ res.client.prenom }}</div>
              <div class="text-xs text-gray-500">{{ res.client.telephone }}</div>
            </td>
            <td class="py-3 px-4">{{ res.chambre.numero }} â€“ {{ res.chambre.type }}</td>
            <td class="py-3 px-4 text-sm text-gray-500">
              {{ res.dateDebut }} â†’ {{ res.dateFin }} ({{ getNombreDeNuits(res) }} nuits)
            </td>
            <td class="py-3 px-4">
              <span class="px-2 inline-flex text-xs font-semibold rounded-full"
                    [ngClass]="{
                      'bg-yellow-100 text-yellow-800': res.statut === 'RÃ©servÃ©e',
                      'bg-green-100 text-green-800': res.statut === 'Checked-in',
                      'bg-gray-200 text-gray-800': res.statut === 'Check-out'
                    }">
                {{ res.statut }}
              </span>
            </td>
            <td class="py-3 px-4">
              <div class="flex gap-2 justify-center flex-wrap">
                <button *ngIf="res.statut === 'RÃ©servÃ©e'" (click)="checkIn(res)"
                        class="action-button bg-green-500 hover:bg-green-600">
                  <i class="fas fa-sign-in-alt mr-1"></i> Check-In
                </button>
                <button *ngIf="res.statut === 'Checked-in'" (click)="previewFacture(res)"
                        class="action-button bg-yellow-500 hover:bg-yellow-600">
                  <i class="fas fa-file-invoice mr-1"></i> Check-Out
                </button>
                <button *ngIf="res.statut === 'Check-out'" (click)="consulterFacture(res)"
                        class="action-button bg-blue-500 hover:bg-blue-600">
                  <i class="fas fa-receipt mr-1"></i> Facture
                </button>
                <button *ngIf="res.statut === 'Checked-in'" (click)="toggleFicheClient(res.id!)"
                        class="action-button bg-purple-500 hover:bg-purple-600">
                  <i class="fas fa-id-card mr-1"></i>
                  {{ fichesVisibles[res.id!] ? 'Masquer fiche' : 'Voir fiche' }}
                </button>
              </div>
            </td>
          </tr>

          <!-- Fiche client -->
          <tr *ngIf="fichesVisibles[res.id!]">
            <td colspan="5" class="p-0">
              <div class="bg-gray-50 p-6">
                <h3 class="text-xl font-bold mb-4 text-blue-800">
                  Fiche Client â€” {{ res.client.nom }} {{ res.client.prenom }}
                </h3>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                  <div class="bg-white p-4 rounded-lg shadow">
                    <p><b>Chambre :</b> {{ res.chambre.numero }} ({{ res.chambre.type }})</p>
                    <p><b>SÃ©jour :</b> {{ res.dateDebut }} â†’ {{ res.dateFin }} ({{ getNombreDeNuits(res) }} nuits)</p>
                    <p><b>TÃ©lÃ©phone :</b> {{ res.client.telephone }}</p>
                  </div>
                  <div class="bg-white p-4 rounded-lg shadow">
                    <p><b>HÃ©bergement :</b>
                      {{ (res.chambre.prixParNuit * getNombreDeNuits(res)) | number:'1.2-2' }} â‚¬
                    </p>
                    <p><b>Restauration :</b>
                      {{ totalParType(res.id!, 'RESTAURATION') | number:'1.2-2' }} â‚¬
                    </p>
                    <p><b>Annexes :</b>
                      {{ totalParType(res.id!, 'ANNEXE') | number:'1.2-2' }} â‚¬
                    </p>
                    <p class="font-bold text-blue-700">
                      Total sÃ©jour :
                      {{ totalSejour(res) | number:'1.2-2' }} â‚¬
                    </p>
                  </div>
                </div>

                <!-- Liste des consommations -->
                <h4 class="font-semibold text-gray-700 mb-2">Consommations</h4>
                <div class="overflow-x-auto">
                  <table class="w-full border rounded-lg mb-4">
                    <thead class="bg-gray-200 text-gray-700">
                      <tr>
                        <th class="px-3 py-2 text-left">Type</th>
                        <th class="px-3 py-2 text-left">Date</th>
                        <th class="px-3 py-2 text-left">Description</th>
                        <th class="px-3 py-2 text-right">Montant (â‚¬)</th>
                      </tr>
                    </thead>
                    <tbody>
                      <ng-container *ngFor="let c of consommationsParReservation[res.id!]">
                        <tr class="hover:bg-gray-50">
                          <td class="px-3 py-2">
                            <span class="text-xs px-2 py-1 rounded-full"
                                  [ngClass]="{
                                    'bg-emerald-100 text-emerald-700': (c.type || '').toUpperCase() === 'RESTAURATION',
                                    'bg-indigo-100 text-indigo-700': (c.type || '').toUpperCase() === 'ANNEXE'
                                  }">
                              {{ c.type }}
                            </span>
                          </td>
                          <td class="px-3 py-2">{{ c.date }}</td>
                          <td class="px-3 py-2">
                             {{ getDescription(c) }}


                            <details class="mt-1">
                              <summary class="text-xs text-gray-600 cursor-pointer">DÃ©tails</summary>
                              <ul class="text-xs text-gray-700 list-disc ml-5 mt-1">
                                <li *ngFor="let a of c.articles">
                                  {{ a.nom }} â€” {{ a.quantite }} Ã— {{ a.prixUnitaire | number:'1.2-2' }} â‚¬
                                </li>
                              </ul>
                            </details>
                          </td>
                          <td class="px-3 py-2 text-right font-semibold">
                           {{ getMontantTotal(c) | number:'1.2-2' }}

                          </td>
                        </tr>
                      </ng-container>
                    </tbody>
                  </table>
                </div>

                <!-- Ajout de service annexe -->
                <button class="bg-green-600 text-white py-2 px-4 rounded-full shadow hover:bg-green-700"
                        (click)="ouvrirFormulaireService(res.id!)">
                  <i class="fas fa-plus mr-1"></i> Ajouter un service annexe
                </button>
              </div>
            </td>
          </tr>
        </ng-container>
      </tbody>
    </table>

    <div *ngIf="reservationsFiltrees.length === 0" class="text-center py-12 text-gray-500 text-lg">
      Aucune rÃ©servation trouvÃ©e.
    </div>
  </div>
</div>
